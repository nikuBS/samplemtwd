<%- include('../../components/start.component.html', { pageInfo: locals.pageInfo,
    includeRoam: true,
    includeCalendar: true,
  }); %>
<body class="rn">
<div id="roamingMain" class="wrap">
    <div id="gnb">
        <span class="menu icon-gnb-menu">
            <img src="<%= CDN %>/img/product/roam/ico_menu_b.svg" alt="메뉴" width="24" height="24" />
        </span>
        <img class="logo" src="<%= CDN %>/img/product/roam/logo.png" alt="로고" width="94" height="24" />
        <a href="/common/search-main">
            <img class="search" src="<%= CDN %>/img/svg/icon_48px_titlebar_search.svg" width="24" height="24" alt="검색"/>
        </a>
    </div>
    <img class="background" src="<%= CDN %>/img/product/roam/bg-map.png" alt="배경"/>
    <%- include('../components/header.component.html', { title: 'T로밍', svcInfo: svcInfo }) %>
    <div id="content">
        <% if (newbie && newbie.isRoamingFirstTime === 'Y') { %>
        <h2><span class="colorPoint">baro 무료통화</span>와 함께</h2>
        <h2>안전한 여행하세요!</h2>
        <p class="description">
            로밍이 처음이신가요?<br />
            로밍요금제를 이용하시면 baro를 통해 음성통화가 무료로 제공됩니다.
        </p>
        <% } else { %>
        <h2>해외여행 갈 땐</h2>
        <h2 class="colorPoint">T로밍과 함께 !</h2>
        <p class="description">
            T로밍 요금제를 통해 해외에서도 국내처럼 <br />
            자유롭게 baro 통화하세요.
        </p>
        <% } %>

        <% if (currentUse && currentUse.prodInfoTxt) { %>
        <a href="/product/roaming/my-use">
        <div class="card-compact">
            <span class="status">이용중</span>
            <span class="text" id="currentUseText"><%= currentUse.prodInfoTxt %></span>
            <img class="arrow" src="<%= CDN %>/img/product/roam/ico_arrow.png" width="13" />
        </div>
        </a>
        <% } %>
        <div class="card">
            <h3>국가별 맞춤 로밍 요금제 추천</h3>
            <p class="description">여행하실 나라를 선택해주세요</p>
            <div id="nations">
                <ul></ul> 
            </div>
            <p class="description">찾으시는 나라가 없으신가요?</p>
            <form action="#" onsubmit="return searchNation();">
                <div class="field-container">
                    <input type="text" placeholder="원하시는 국가 명을 입력해주세요" id="nation-search" />
                    <img src="<%= CDN %>/img/product/roam/ico_search_a.png" class="search"
                         onclick="searchNation();"
                         width="21" height="21" alt="Search" />
                </div>
            </form>
            <div class="link">
                <a href="#" onclick="openNationsDialog(); return false;">전체 국가 보기</a>
            </div>
        </div>
        <% if (recentUse) { %>
        <div class="card">
            <h3>최근 이용하신 로밍요금제</h3>
            <div class="history">
                <a href="/product/callplan?prod_id=<%= recentUse.prodId %>">
                    <h4>
                        <%= recentUse.prodNm %>
                    </h4>
                </a>
                <div class="range">
                    <svg height="13" viewBox="0 0 26 26" width="13" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="m0 0h26v26h-26z" fill="#4559fc" opacity="0"/><g stroke="#4559fc"><rect height="19" rx="2" stroke-width="2" width="22" x="2.000097" y="4"/><path d="m1 9.355773h23.778487" stroke-width="2"/><path d="m7.500097 13.5h1v1h-1z" fill="#333"/><path d="m7.500097 17.5h1v1h-1z" fill="#333"/><path d="m12.500097 13.5h1v1h-1z" fill="#333"/><path d="m12.500097 17.5h1v1h-1z" fill="#333"/><path d="m17.500097 13.5h1v1h-1z" fill="#333"/><path d="m17.500097 17.5h1v1h-1z" fill="#333"/><path d="m7.000097 1.850952v4.292114" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/><path d="m19.000097 1.850952v4.292114" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></g></g></svg>
                    <%= recentUse.formattedStartDate %>
                    ~
                    <%= recentUse.formattedEndDate %>
                </div>
                <span class="days">
                    <%= recentUse.nights %>박
                    <%= recentUse.nights + 1 %>일
                </span>
            </div>
            <!--
            <div class="link">
                <a href="/product/roaming/history">지난 여행 이용 패턴</a>
            </div>
            -->
        </div>
        <% } else if (banners.topBanners && banners.topBanners.length > 0) { %>
        <div class="banner">
            <a href="<%= banners.topBanners[0].imgLinkUrl %>">
                <img src="<%= CDN %><%= banners.topBanners[0].bnnrFilePathNm %>"
                     alt="<%= banners.topBanners[0].bnnrImgAltCtt %>" />
            </a>
        </div>
        <% } %>
        <div class="card">
            <h3>로밍 요금제 한눈에 보기</h3>
            <div id="groups">
            </div>
        </div>
        <% if (process.env['NODE_ENV'] == 'local') { %>
        <div class="card">
            <h3>SUPPORT CARD</h3>
            <div class="buttons" style="padding-top: 20px;">
                <div class="button button-1" onclick="debugChangeMcc();">
                    MCC Update
                </div>
                <div class="button button-2" onclick="debugChangeUserId();">
                    TID Update
                    <% if (svcInfo && svcInfo.userId) { %>
                        (<%= svcInfo.userId %>)
                    <% } %>
                </div>
            </div>
        </div>
        <% } %>
        <div class="card no-padding">
            <a href="/product/roaming/coupon">
                <div class="menu-link border-bottom">
                    <img class="icon" src="<%= CDN %>/img/product/roam/ico_coupon.png" width="32" />
                    <span>로밍 카드/쿠폰</span>
                    <img class="arrow" src="<%= CDN %>/img/product/roam/ico_arrow.png" width="13" />
                </div>
            </a>
            <a href="/product/roaming/fi/guide">
                <div class="menu-link">
                    <img class="icon" src="<%= CDN %>/img/product/roam/ico_barobox.png" width="32" />
                    <span>baro Box 대여</span>
                    <img class="arrow" src="<%= CDN %>/img/product/roam/ico_arrow.png" width="13" />
                </div>
            </a>
        </div>
    </div>
    <a href="/product/roaming/info/guide">
        <div class="info-link">
            출국 전 알아두면 좋은 정보
            <img class="arrow" src="<%= CDN %>/img/product/roam/ico_arrow.png" width="13" />
        </div>
    </a>
    <a href="/product/roaming/info/guide?reqItem=lost">
        <div class="info-link" style="border-bottom: 1px solid #ededed;">
            <div class="separator-top"></div>
            로밍 중 휴대폰 분실 안내
            <img class="arrow" src="<%= CDN %>/img/product/roam/ico_arrow.png" width="13" />
        </div>
    </a>
    <div class="links">
        <div class="other-link">
            <a href="/product/roaming/info/center">로밍 센터 안내</a>
        </div>
        <div class="divider"></div>
        <div class="other-link">
            <a href="/customer/faq/category?id=1400000&title=%EB%A1%9C%EB%B0%8D">자주하는 질문</a>
        </div>
    </div>
</div>
<%- include('../../components/roaming-next/schedule.picker.html'); %>
<%- include('../../components/roaming-next/roaming.menu.html'); %>
<script type="text/x-handlebars-template" id="tpl-nation-card">
    <li style="width: {{width}}px; height: {{height}}px;"
        onclick="openScheduleDialog('{{ code }}', '{{ name }}', null, '#roamingMain');">
        {{#if imageUrl}}
            <img src="{{ imageUrl }}" width="{{ width }}" height="{{ height }}" alt="{{ imageAlt }}">
            <!-- <span class="name">{{ name }}</span> -->
        {{else}}
            <span class="name-dark">{{ name }}</span>
        {{/if}}
    </li>
</script>
<script type="text/x-handlebars-template" id="tpl-tariff-group-card">
    <a href="/product/roaming/fee#{{ id }}"><div class="group">
            <img src="<%= CDN %>/img/product/roam/{{ icon }}" alt="product-icon" />
            <h4>{{ title }}</h4>
            <h5>{{ subtitle }}</h5>
        </div></a>
</script>
</body>
<% include ../../components/javascript.component.html %>
<script type="text/javascript">
  var baseDiv = '#roamingMain';

  $(document).ready(function () {
    new Tw.NextRoamingMenu($(baseDiv)).install();
    new Tw.NextRoaming($(baseDiv), '<%= pageInfo.menuId %>')
    fillPopularNations();
    fillTariffGroups();

    installNationSearch(openScheduleDialog);
    beautifyCurrentUse();
  });

  function beautifyCurrentUse() {
    var dom = document.getElementById('currentUseText');
    if (dom != null) {
      var text = dom.innerText;
      var match = new RegExp('[0-9]+건$').exec(text);
      if (match) {
        var html = text.substring(0, match.index) + '<span class="point">' + text.substring(match.index) + '</span>';
        dom.innerHTML = html;
      }
    }
  }

  function fillPopularNations() {
    const GAP = 6;
    const COLUMN = 3;
    const container = document.getElementById('nations');
    const nationWidth = Math.floor((container.clientWidth - GAP * COLUMN) / COLUMN);
    const ul = document.querySelector('#nations ul');
    const template = Handlebars.compile($('#tpl-nation-card').html());

    var cdn = '<%= CDN %>';
    if (cdn.indexOf(':3001') > 0) {
      cdn = 'http://mtw.told.me/cdn/';
    }

    for (let i = 0; i < popularNations.length; i++) {
      const item = popularNations[i];
      var imageUrl = cdn + item.mblBtnImg;
      if (!item.mblBtnImg) {
        imageUrl = null;
      }
      const li = template({
        width: nationWidth - GAP,
        height: (nationWidth - GAP) * 0.727,
        name: item.countryNameKor,
        code: item.countryCode,
        imageUrl: imageUrl,
        imageAlt: item.mblBtnImgAltCtt,
      });
      ul.innerHTML += li;
    }
  }

  function fillTariffGroups() {
    const template = Handlebars.compile($('#tpl-tariff-group-card').html());
    const container = document.getElementById('groups');
    container.innerHTML = '';
    for (var i=0; i<tariffList.length; i++) {
      const item = tariffList[i];
      container.innerHTML += template({
        id: item.id,
        icon: item.icon,
        title: item.name,
        subtitle: item.description,
      });
    }
  }

  function closeDialog() {
    $('#nationsDialog').css('display', 'none');
    $('#scheduleDialog').css('display', 'none');
    $(baseDiv).css('display', 'block');
  }

  function debugChangeMcc() {
    var newMcc = prompt('MCC 값 3자리를 입력해주세요');
    if (newMcc) {
      document.cookie = 'ROAMING_MCC=' + newMcc + '; path=/';
      setTimeout(function() {
        document.location.href = '/product/roaming/on?mcc=' + newMcc;
      }, 500);
    }
  }

  function debugChangeUserId() {
    var userId = prompt('TID를 입력하세요');
    if (userId) {
      document.location.href = '/product/roaming?tid=' + userId;
    }
  }

  // TODO: 198 API 연동후 삭제
  const tariffList = [
    {id: 'baro', name: 'baro 요금제', description: '전세계 주요국가에서', icon: 'icon_planet.png'},
    {id: 'onepass', name: 'One Pass', description: '출장을 자주 간다면', icon: 'icon_onepass.png'},
    {id: 'vip', name: 'One Pass VIP', description: '해외에서도 데이터를 무제한으로', icon: 'icon_vip.png'},
    {id: 'guam', name: '괌사이판', description: '괌,사이판 여행필수품', icon: 'icon_guam.png'},
    {id: 'longpass', name: 'LongPass', description: '중동, 아프리카에서도', icon: 'icon_longpass.png'},
  ];

  var popularNations = <%- JSON.stringify(popularNations) %>;
</script>
<% include ../../components/roaming-next/calendar.javascript.html %>
<% include ../../components/end.component.html %>
