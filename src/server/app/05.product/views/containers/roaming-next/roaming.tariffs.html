<%- include('../../components/start.component.html', { pageInfo: locals.pageInfo, includeRoam: true }); %>
<body class="rn">
<div id="roamingTariffs">
    <div id="gnb" class="gnb-opaque">
        <span class="menu icon-gnb-menu">
            <img src="<%= CDN %>/img/product/roam/ico_menu_b.svg" alt="메뉴" width="24" height="24" />
        </span>
        <h1>T로밍 요금제</h1>
    </div>
    <%- include('../components/header.component.html', { title: '', svcInfo: svcInfo }) %>
    <div class="header">
        <h2>나의 여행 <span class="colorPoint">패턴</span>을 <span class="colorPoint">선택</span>해보세요!</h2>
        <div class="anchors">
            <div class="anchor" id="a-group-baro" onclick="showGroup(this)">
                <img src="<%= CDN %>/img/product/roam/tab_01_on.png" width="128" />
            </div>
            <div class="anchor" id="a-group-onepass" onclick="showGroup(this)">
                <img src="<%= CDN %>/img/product/roam/tab_02_off.png" width="128" />
            </div>
            <div class="anchor" id="a-group-vip" onclick="showGroup(this)">
                <img src="<%= CDN %>/img/product/roam/tab_03_off.png" width="128" />
            </div>
            <div class="anchor" id="a-group-guam" onclick="showGroup(this)">
                <img src="<%= CDN %>/img/product/roam/tab_04_off.png" width="128" />
            </div>
            <div class="anchor" id="a-group-longpass" onclick="showGroup(this)">
                <img src="<%= CDN %>/img/product/roam/tab_05_off.png" width="128" />
            </div>
        </div>
    </div>
    <div id="groups">
    </div>
</div>
<script type="text/x-handlebars-template" id="tpl-tariff-group">
    <div class="group" id="{{id}}">
        <div class="summary">
            <img src="<%= CDN %>/img/product/roam/{{ background }}" />
            <h2>{{ name }}</h2>
            <p>
                {{{ description }}}
            </p>
        </div>
        <div class="tariffs">
            {{#each items}}
                <div class="tariff" onclick="showPlan('{{ id }}');">
                    <span class="price">{{ price }}</span>
                    <h3>{{ name }}</h3>
                    <div class="data">
                        <img src="<%= CDN %>/img/product/roam/ico_storage.svg" width="12" height="12" alt="storage" />
                        <span>{{ data }}</span>
                    </div>
                    <span class="phone">{{ phone }}</span>
                </div>
            {{/each}}
        </div>
    </div>
</script>
<%- include('../../components/roaming-next/roaming.menu.html', {svcInfo}); %>
</body>
<% include ../../components/javascript.component.html %>
<script type="text/javascript">
  const groups = <%- JSON.stringify(groupsHardcoded) %>;
  const groupMetas = {
    'group-baro': {top: 0, height: 0},
    'group-onepass': {},
    'group-vip': {},
    'group-guam': {},
    'group-longpass': {},
  }
  const imagePrefix = "<%= CDN %>/img/product/roam/tab_0";
  var scrollMonitor = true;
  var selectedAnchor = 'a-group-baro';

  function showPlan(id) {
    var path = '/product/callplan?prod_id=' + id;
    document.location.href = path;
  }

  $(document).ready(function () {
    fillTariffs();
    initScrollAnchors();
    new Tw.NextRoamingMenu($('#roamingTariffs')).install();

    var i0 = document.location.href.lastIndexOf('#');
    if (i0 !== -1) {
      var hash = document.location.href.substring(i0 + 1);
      showGroupImpl('group-' + hash, 'a-group-' + hash);
    }
  });

  function initScrollAnchors() {
    for (var k of Object.keys(groupMetas)) {
      var div = document.getElementById(k);
      groupMetas[k].top = div.offsetTop;
      groupMetas[k].height = div.offsetHeight;
    }
    console.log(groupMetas);

    var anchors = $('.header .anchors');
    $(window).scroll(function(e) {
      if (!scrollMonitor)
        return;

      var scrollTop = $(window).scrollTop();
      if (scrollTop > 63) {
        anchors.css('position', 'fixed');
        anchors.css('left', '0');
        anchors.css('right', '0');
        anchors.css('top', '50px');
        anchors.css('height', '94px');

        for (var k of Object.keys(groupMetas)) {
          var meta = groupMetas[k];
          if (scrollTop > meta.top - 200 && scrollTop < meta.top - 200 + meta.height) {
            const thatId = 'a-' + k;
            $('.header .anchor').each(function(i, val) {
              var state = val.id === thatId ? 'on' : 'off';
              $('#' + val.id + ' img').attr('src', imagePrefix + (i+1) + '_' + state + '.png');
              if (state === 'on' && selectedAnchor !== thatId) {
                var offsetLeft = val.offsetLeft - 20;
                $('.anchors').animate({
                  scrollLeft: offsetLeft,
                }, 250);
                selectedAnchor = thatId;
              }
            });
            break;
          }
        }
      } else {
        anchors.css('position', 'static');
      }
    });
  }

  function showGroup(e) {
    var groupId = e.id.substring(2);
    showGroupImpl(groupId, e.id);
  }

  function showGroupImpl(groupId, anchorId) {
    scrollMonitor = false;
    $([document.documentElement, document.body]).animate({
      scrollTop: groupMetas[groupId].top - 200,
    }, 280, function() {
      scrollMonitor = true;
    });

    $('.header .anchor').each(function(i, val) {
      var state = val.id === anchorId ? 'on' : 'off';
      $('#' + val.id + ' img').attr('src', imagePrefix + (i+1) + '_' + state + '.png');

      if (state === 'on') {
        var offsetLeft = val.offsetLeft - 20;
        $('.anchors').animate({
          scrollLeft: offsetLeft,
        }, 200);
      }
    });

  }

  function fillTariffs() {
    const template = Handlebars.compile($('#tpl-tariff-group').html());
    const target = document.getElementById('groups');
    target.innerHTML = '';
    for (var group of groups) {
      target.innerHTML += template(group);
    }
  }
</script>
<% include ../../components/end.component.html %>
